<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Agri-Advisor Pro | Streaming</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2e7d32; --sidebar-bg: #1f2937; --bg: #f3f4f6; --border: #e5e7eb; --danger: #ef4444; }
        body { font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; background-color: var(--bg); direction: rtl; }
        #login-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-card { background: white; padding: 40px; border-radius: 12px; text-align: center; width: 320px; }
        .sidebar { width: 280px; background: var(--sidebar-bg); color: white; display: flex; flex-direction: column; padding: 20px; border-left: 1px solid #374151; }
        .new-chat-btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 600; margin-bottom: 20px; font-family: inherit; transition: 0.2s; }
        .new-chat-btn:hover { filter: brightness(1.1); }
        .logout-btn { background: rgba(239, 68, 68, 0.1); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.3); padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; font-family: inherit; transition: 0.2s; margin-top: 15px; }
        .logout-btn:hover { background: var(--danger); color: white; }
        .chat-list { flex-grow: 1; overflow-y: auto; }
        .chat-item-container { display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 5px; border-radius: 4px; cursor: pointer; background: rgba(255,255,255,0.05); font-size: 0.85rem; transition: 0.2s; }
        .chat-item-container:hover { background: rgba(255,255,255,0.1); }
        .chat-item-container.active { background: #374151; border-right: 3px solid #4caf50; }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; }
        header { text-align: center; background: white; padding: 10px; border-bottom: 1px solid var(--border); }
        .settings-bar { padding: 10px 20px; background: #fff; border-bottom: 1px solid var(--border); display: flex; justify-content: center; gap: 20px; align-items: center; }
        #chat-window { flex-grow: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 15px; }
        .message { max-width: 75%; padding: 12px 16px; border-radius: 12px; line-height: 1.5; font-size: 0.95rem; }
        .message.user { align-self: flex-start; background: var(--primary); color: white; }
        .message.bot { align-self: flex-end; background: white; border: 1px solid var(--border); }
        .input-area { padding: 15px; background: white; border-top: 1px solid var(--border); display: flex; gap: 10px; }
        textarea { flex-grow: 1; border: 1px solid var(--border); border-radius: 8px; padding: 10px; resize: none; height: 45px; font-family: inherit; text-align: right; }
        .settings-input { padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; }

        /* ×¢×™×¦×•×‘ ×œ×¡×˜×˜×•×¡ ×”×¡×•×›×Ÿ ×‘×–××Ÿ ×××ª */
        .agent-status { font-size: 0.75rem; color: #10b981; margin-bottom: 8px; font-weight: 600; display: flex; gap: 5px; align-items: center; }
        .pulse-dot { width: 6px; height: 6px; background-color: #10b981; border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-card">
            <h2 style="color: var(--primary);">ğŸŒ± Agri-Advisor Pro</h2>
            <input type="text" id="username-input" class="settings-input" style="width: 80%; margin-bottom: 15px; text-align: center;" placeholder="×©× ××©×ª××©" onkeydown="if(event.key === 'Enter') login()">
            <button onclick="login()" class="new-chat-btn" style="width: 100%; margin-bottom: 0;">×”×›× ×¡</button>
        </div>
    </div>

    <div class="sidebar">
        <button class="new-chat-btn" onclick="createNewChat()">+ ×©×™×—×” ×—×“×©×”</button>
        <div class="chat-list" id="chat-list"></div>
        <div id="user-display" style="font-size: 0.85rem; opacity: 0.7; text-align: center; margin-top: 10px;"></div>
        <button class="logout-btn" onclick="logout()">ğŸšª ×”×ª× ×ª×§</button>
    </div>

    <div class="main-content">
        <header><h2 id="main-title" style="margin:0; color:var(--primary);">Israel Agri-Advisor</h2></header>
        <div class="settings-bar">
            <label>ğŸ“ ××™×§×•×:</label>
            <select id="city-input" class="settings-input">
                <option value="">×‘×—×¨ ×¢×™×¨...</option>
                <option value="ariel">××¨×™××œ</option>
                <option value="ashdod">××©×“×•×“</option>
                <option value="ashkelon">××©×§×œ×•×Ÿ</option>
                <option value="avne eitan">××‘× ×™ ××™×ª×Ÿ</option>
                <option value="beer sheva">×‘××¨ ×©×‘×¢</option>
                <option value="eilat">××™×œ×ª</option>
                <option value="hadera">×—×“×¨×”</option>
                <option value="haifa bate zakuk">×—×™×¤×” ×‘×ª×™ ×–×™×§×•×§</option>
                <option value="haifa technion">×—×™×¤×” ×˜×›× ×™×•×Ÿ</option>
                <option value="jerusalem center">×™×¨×•×©×œ×™× ××¨×›×–</option>
                <option value="lev kineret">×œ×‘ ×›×™× ×¨×ª</option>
                <option value="maale gilboa">××¢×œ×” ×’×œ×‘×•×¢</option>
                <option value="nitzan">× ×™×¦×Ÿ</option>
                <option value="tlv beach">×—×•×£ ×ª×œ ××‘×™×‘</option>
                <option value="yotvata">×™×•×˜×‘×ª×”</option>
                <option value="zichron yaakov">×–×›×¨×•×Ÿ ×™×¢×§×‘</option>
            </select>
            <label>ğŸ“… ×ª××¨×™×š:</label>
            <input type="date" id="target-date" class="settings-input" min="2025-01-01" max="2025-12-31">
        </div>
        <div id="chat-window"></div>
        <div class="input-area">
            <textarea id="query" placeholder="×©××œ ×©××œ×” ×—×§×œ××™×ª..."></textarea>
            <button class="new-chat-btn" onclick="sendMessage()" style="margin:0;">×©×œ×—</button>
        </div>
    </div>

<script>
        let currentUser = ""; let currentChatId = "";

        function login() {
            currentUser = document.getElementById('username-input').value.trim();
            if (!currentUser) return;
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('user-display').innerText = `××—×•×‘×¨: ${currentUser}`;
            showWelcome(); loadUserChats();
        }

        function logout() {
            currentUser = ""; currentChatId = "";
            document.getElementById('username-input').value = "";
            document.getElementById('user-display').innerText = "";
            document.getElementById('chat-list').innerHTML = "";
            document.getElementById('chat-window').innerHTML = "";
            document.getElementById('login-overlay').style.display = 'flex';
        }

        function showWelcome() {
            currentChatId = "";
            document.getElementById('chat-window').innerHTML = `<div class="message bot">ğŸ‘‹ ×©×œ×•× <b>${currentUser}</b>! ×‘×—×¨ ××™×§×•× ×•×ª××¨×™×š ×-2025 ×‘×¡×¨×’×œ ×œ××¢×œ×”, ×•×©××œ ××•×ª×™ ×›×œ ×“×‘×¨.</div>`;
        }

        async function loadUserChats() {
            if (!currentUser) return;
            const res = await fetch(`/api/my-chats/${currentUser}`);
            const chats = await res.json();
            const list = document.getElementById('chat-list'); list.innerHTML = "";
            chats.forEach(chat => {
                const div = document.createElement('div');
                div.className = `chat-item-container ${chat.chat_id === currentChatId ? 'active' : ''}`;
                div.innerHTML = `<span style="flex-grow:1" onclick="loadChatHistory('${chat.chat_id}', '${chat.title}')">${chat.title}</span><span style="color:var(--danger);" onclick="deleteChat('${chat.chat_id}')">ğŸ—‘ï¸</span>`;
                list.appendChild(div);
            });
            return chats;
        }

        async function loadChatHistory(chatId, title) {
            currentChatId = chatId; const parts = title.split(' | ');
            if(parts.length >= 3) { document.getElementById('city-input').value = parts[1]; document.getElementById('target-date').value = parts[2]; }
            const res = await fetch(`/api/chat-history/${chatId}`); const history = await res.json();
            document.getElementById('chat-window').innerHTML = ""; history.forEach(msg => appendMsg(msg.content, msg.role === 'user' ? 'user' : 'bot'));
            loadUserChats();
        }

        async function sendMessage() {
            const query = document.getElementById('query').value.trim();
            const city = document.getElementById('city-input').value;
            const date = document.getElementById('target-date').value;
            if (!query) return;
            if (!city || !date) { appendMsg("âš ï¸ ×× × ×‘×—×¨ ××™×§×•× ×•×ª××¨×™×š ×§×•×“×!", 'bot'); return; }
            if (!currentChatId) currentChatId = "chat_" + Date.now();

            appendMsg(query, 'user');
            document.getElementById('query').value = "";

            // ×™×¦×™×¨×ª ×‘×•×¢×ª ×”×©×™×—×” ×œ×¡×•×›×Ÿ ×‘×–××Ÿ ×××ª
            const chatWindow = document.getElementById('chat-window');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message bot';

            const statusDiv = document.createElement('div');
            statusDiv.className = 'agent-status';
            statusDiv.innerHTML = '<div class="pulse-dot"></div><span>××ª×—×‘×¨ ×œ×¡×•×›×Ÿ...</span>';

            const contentDiv = document.createElement('div');

            msgDiv.appendChild(statusDiv);
            msgDiv.appendChild(contentDiv);
            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;

            try {
                // ×§×¨×™××ª Streaming ×—×“×©×”
                const res = await fetch('/get-advice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_name: currentUser, chat_id: currentChatId, query: query, city: city, date: date })
                });

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let fullText = "";
                let buffer = "";

                // ×œ×•×œ××” ×©×××–×™× ×” ×œ× ×ª×•× ×™× ×©××’×™×¢×™× ×‘×¨×¦×£ ××”×©×¨×ª
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    let lines = buffer.split('\n\n');
                    buffer = lines.pop(); // ×©××™×¨×ª ×”×©××¨×™×ª ×‘×‘××¤×¨ ×œ××§×¨×” ×©×”×˜×§×¡×˜ × ×—×ª×š ×‘×××¦×¢

                    for (let line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.type === 'status') {
                                    statusDiv.innerHTML = `<div class="pulse-dot"></div><span>${data.message}</span>`;
                                } else if (data.type === 'token') {
                                    statusDiv.innerHTML = `<span style="color:#6b7280; font-size: 0.75rem;">âœï¸ ××§×œ×™×“ ×ª×©×•×‘×”...</span>`;
                                    fullText += data.text;
                                    contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(fullText));
                                    chatWindow.scrollTop = chatWindow.scrollHeight;
                                } else if (data.type === 'done') {
                                    statusDiv.style.display = 'none'; // ×”×¢×œ××ª ×”×¡×˜×˜×•×¡ ×›×©×”×¡×•×›×Ÿ ×¡×™×™×
                                    loadUserChats();
                                } else if (data.type === 'error') {
                                    statusDiv.style.display = 'none';
                                    contentDiv.innerHTML += `<br><span style="color:red">${data.message}</span>`;
                                }
                            } catch(e) { console.error("Parse error on chunk"); }
                        }
                    }
                }
            } catch (e) {
                statusDiv.innerHTML = `<span style="color:red;">×©×’×™××ª ×ª×§×©×•×¨×ª</span>`;
            }
        }

        function appendMsg(content, role) {
            const div = document.createElement('div'); div.className = `message ${role}`;
            div.innerHTML = marked.parse(content); document.getElementById('chat-window').appendChild(div);
            document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;
        }

        async function deleteChat(id) { if(confirm("×œ××—×•×§ ××ª ×”×©×™×—×”?")) { await fetch(`/api/delete-chat/${id}`, { method: 'DELETE' }); if(currentChatId === id) showWelcome(); loadUserChats(); } }
        function createNewChat() { showWelcome(); loadUserChats(); }
        document.getElementById('query').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
    </script>
</body>
</html>