<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Agri-Advisor Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2e7d32; --sidebar-bg: #1f2937; --bg: #f3f4f6; --border: #e5e7eb; --danger: #ef4444; }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; background-color: var(--bg); direction: rtl; }

        /* Login */
        #login-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-card { background: white; padding: 40px; border-radius: 12px; text-align: center; width: 320px; }

        /* Sidebar */
        .sidebar { width: 260px; background: var(--sidebar-bg); color: white; display: flex; flex-direction: column; padding: 16px; border-left: 1px solid #374151; flex-shrink: 0; }
        .new-chat-btn { background: var(--primary); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; margin-bottom: 16px; font-family: inherit; transition: 0.2s; width: 100%; }
        .new-chat-btn:hover { filter: brightness(1.1); }
        .logout-btn { background: rgba(239,68,68,0.1); color: #fca5a5; border: 1px solid rgba(239,68,68,0.3); padding: 9px; border-radius: 6px; cursor: pointer; font-weight: 600; font-family: inherit; transition: 0.2s; margin-top: 12px; width: 100%; }
        .logout-btn:hover { background: var(--danger); color: white; }
        .chat-list { flex-grow: 1; overflow-y: auto; }
        .chat-item-container { display: flex; justify-content: space-between; align-items: center; padding: 9px; margin-bottom: 4px; border-radius: 4px; cursor: pointer; background: rgba(255,255,255,0.05); font-size: 0.82rem; transition: 0.2s; }
        .chat-item-container:hover { background: rgba(255,255,255,0.1); }
        .chat-item-container.active { background: #374151; border-right: 3px solid #4caf50; }

        /* Main */
        .main-content { flex-grow: 1; display: flex; flex-direction: column; min-width: 0; }
        header { text-align: center; background: white; padding: 10px; border-bottom: 1px solid var(--border); }
        .settings-bar { padding: 8px 16px; background: #fff; border-bottom: 1px solid var(--border); display: flex; justify-content: center; gap: 16px; align-items: center; flex-wrap: wrap; }
        .settings-input { padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; }

        /* Chat window */
        #chat-window { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 14px; }
        .message { max-width: 78%; padding: 12px 16px; border-radius: 12px; line-height: 1.55; font-size: 0.93rem; }
        .message.user { align-self: flex-start; background: var(--primary); color: white; }
        .message.bot  { align-self: flex-end; background: white; border: 1px solid var(--border); }

        /* Steps trace */
        .steps-toggle { margin-top: 10px; font-size: 0.78rem; color: #6b7280; cursor: pointer; user-select: none; display: flex; align-items: center; gap: 4px; }
        .steps-toggle:hover { color: var(--primary); }
        .steps-panel { display: none; margin-top: 8px; border-top: 1px solid var(--border); padding-top: 8px; }
        .steps-panel.open { display: block; }
        .step-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 8px; overflow: hidden; font-size: 0.78rem; }
        .step-header { background: #374151; color: white; padding: 5px 10px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .step-module-badge { background: #4caf50; border-radius: 4px; padding: 1px 6px; font-size: 0.72rem; }
        .step-section { padding: 6px 10px; }
        .step-section strong { color: #374151; display: block; margin-bottom: 2px; }
        .step-section pre { background: #f3f4f6; border-radius: 4px; padding: 6px; overflow-x: auto; white-space: pre-wrap; word-break: break-word; margin: 0; color: #1f2937; font-size: 0.74rem; }

        /* Thinking indicator */
        .thinking { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: #10b981; font-weight: 600; padding: 10px 14px; background: white; border: 1px solid var(--border); border-radius: 12px; align-self: flex-end; }
        .pulse-dot { width: 7px; height: 7px; background: #10b981; border-radius: 50%; animation: pulse 1.2s infinite; }
        @keyframes pulse { 0%,100%{opacity:.3} 50%{opacity:1} }

        /* Input area */
        .input-area { padding: 12px; background: white; border-top: 1px solid var(--border); display: flex; gap: 8px; }
        textarea { flex-grow: 1; border: 1px solid var(--border); border-radius: 8px; padding: 10px; resize: none; height: 46px; font-family: inherit; text-align: right; font-size: 0.93rem; }
        .run-btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: inherit; transition: 0.2s; white-space: nowrap; }
        .run-btn:hover { filter: brightness(1.1); }
        .run-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-card">
        <h2 style="color:var(--primary);">ğŸŒ± Agri-Advisor Pro</h2>
        <input type="text" id="username-input" class="settings-input"
               style="width:80%;margin-bottom:15px;text-align:center;" placeholder="×©× ××©×ª××©"
               onkeydown="if(event.key==='Enter') login()">
        <button onclick="login()" class="new-chat-btn" style="margin-bottom:0;">×”×›× ×¡</button>
    </div>
</div>

<div class="sidebar">
    <button class="new-chat-btn" onclick="createNewChat()">+ ×©×™×—×” ×—×“×©×”</button>
    <div class="chat-list" id="chat-list"></div>
    <div id="user-display" style="font-size:0.82rem;opacity:0.7;text-align:center;margin-top:8px;"></div>
    <button class="logout-btn" onclick="logout()">ğŸšª ×”×ª× ×ª×§</button>
</div>

<div class="main-content">
    <header><h2 id="main-title" style="margin:0;color:var(--primary);">Israel Agri-Advisor ğŸŒ¾</h2></header>

    <div class="settings-bar">
        <label>ğŸ“ ××™×§×•×:</label>
        <select id="city-input" class="settings-input">
            <option value="">×‘×—×¨ ×¢×™×¨...</option>
            <option value="ariel">××¨×™××œ</option>
            <option value="ashdod">××©×“×•×“</option>
            <option value="ashkelon">××©×§×œ×•×Ÿ</option>
            <option value="avne eitan">××‘× ×™ ××™×ª×Ÿ</option>
            <option value="beer sheva">×‘××¨ ×©×‘×¢</option>
            <option value="eilat">××™×œ×ª</option>
            <option value="hadera">×—×“×¨×”</option>
            <option value="haifa bate zakuk">×—×™×¤×” ×‘×ª×™ ×–×™×§×•×§</option>
            <option value="haifa technion">×—×™×¤×” ×˜×›× ×™×•×Ÿ</option>
            <option value="jerusalem center">×™×¨×•×©×œ×™× ××¨×›×–</option>
            <option value="lev kineret">×œ×‘ ×›×™× ×¨×ª</option>
            <option value="maale gilboa">××¢×œ×” ×’×œ×‘×•×¢</option>
            <option value="nitzan">× ×™×¦×Ÿ</option>
            <option value="tlv beach">×—×•×£ ×ª×œ ××‘×™×‘</option>
            <option value="yotvata">×™×•×˜×‘×ª×”</option>
            <option value="zichron yaakov">×–×›×¨×•×Ÿ ×™×¢×§×‘</option>
        </select>
        <label>ğŸ“… ×ª××¨×™×š:</label>
        <input type="date" id="target-date" class="settings-input" min="2025-01-01" max="2025-12-31">
    </div>

    <div id="chat-window"></div>

    <div class="input-area">
        <textarea id="query" placeholder="×©××œ ×©××œ×” ×—×§×œ××™×ª..."></textarea>
        <button class="run-btn" id="run-btn" onclick="runAgent()">×”×¨×¥ ×¡×•×›×Ÿ â–¶</button>
    </div>
</div>

<script>
let currentUser = "";
let currentChatId = "";

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function login() {
    currentUser = document.getElementById('username-input').value.trim();
    if (!currentUser) return;
    document.getElementById('login-overlay').style.display = 'none';
    document.getElementById('user-display').innerText = `××—×•×‘×¨: ${currentUser}`;
    showWelcome();
    loadUserChats();
}

function logout() {
    currentUser = ""; currentChatId = "";
    document.getElementById('username-input').value = "";
    document.getElementById('user-display').innerText = "";
    document.getElementById('chat-list').innerHTML = "";
    document.getElementById('chat-window').innerHTML = "";
    document.getElementById('login-overlay').style.display = 'flex';
}

// â”€â”€ Chat management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showWelcome() {
    currentChatId = "";
    document.getElementById('chat-window').innerHTML =
        `<div class="message bot">ğŸ‘‹ ×©×œ×•× <b>${currentUser}</b>! ×‘×—×¨ ××™×§×•× ×•×ª××¨×™×š, ×•×œ×—×¥ <b>"×”×¨×¥ ×¡×•×›×Ÿ"</b> ×œ×§×‘×œ×ª ×™×™×¢×•×¥ ×—×§×œ××™.</div>`;
}

async function loadUserChats() {
    if (!currentUser) return;
    const res  = await fetch(`/api/my-chats/${currentUser}`);
    const chats = await res.json();
    const list  = document.getElementById('chat-list');
    list.innerHTML = "";
    chats.forEach(chat => {
        const div = document.createElement('div');
        div.className = `chat-item-container ${chat.chat_id === currentChatId ? 'active' : ''}`;
        div.innerHTML = `
            <span style="flex-grow:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"
                  onclick="loadChatHistory('${chat.chat_id}','${chat.title.replace(/'/g,"\\'")}')">
                ${chat.title}
            </span>
            <span style="color:var(--danger);margin-right:6px;flex-shrink:0;"
                  onclick="deleteChat('${chat.chat_id}')">ğŸ—‘ï¸</span>`;
        list.appendChild(div);
    });
}

async function loadChatHistory(chatId, title) {
    currentChatId = chatId;
    const parts = title.split(' | ');
    if (parts.length >= 3) {
        document.getElementById('city-input').value  = parts[1];
        document.getElementById('target-date').value = parts[2];
    }
    const res  = await fetch(`/api/chat-history/${chatId}`);
    const hist = await res.json();
    const win  = document.getElementById('chat-window');
    win.innerHTML = "";
    hist.forEach(msg => appendMsg(msg.content, msg.role === 'user' ? 'user' : 'bot'));
    loadUserChats();
}

function createNewChat() { showWelcome(); loadUserChats(); }

async function deleteChat(id) {
    if (!confirm("×œ××—×•×§ ××ª ×”×©×™×—×”?")) return;
    await fetch(`/api/delete-chat/${id}`, { method: 'DELETE' });
    if (currentChatId === id) showWelcome();
    loadUserChats();
}

// â”€â”€ Main agent call â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runAgent() {
    const query = document.getElementById('query').value.trim();
    const city  = document.getElementById('city-input').value;
    const date  = document.getElementById('target-date').value;

    if (!query) return;
    if (!city || !date) { appendMsg("âš ï¸ ×× × ×‘×—×¨ ××™×§×•× ×•×ª××¨×™×š ×§×•×“×!", 'bot'); return; }
    if (!currentChatId) currentChatId = "chat_" + Date.now();

    appendMsg(query, 'user');
    document.getElementById('query').value = "";

    // Show thinking indicator
    const win = document.getElementById('chat-window');
    const thinkDiv = document.createElement('div');
    thinkDiv.className = 'thinking';
    thinkDiv.innerHTML = '<div class="pulse-dot"></div><span>×”×¡×•×›×Ÿ ×—×•×©×‘...</span>';
    win.appendChild(thinkDiv);
    win.scrollTop = win.scrollHeight;

    const btn = document.getElementById('run-btn');
    btn.disabled = true;

    try {
        const res = await fetch('/api/execute', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                prompt:    query,
                user_name: currentUser,
                chat_id:   currentChatId,
                city:      city,
                date:      date
            })
        });

        const data = await res.json();
        thinkDiv.remove();

        if (data.status === 'error') {
            appendMsg(`âŒ ×©×’×™××”: ${data.error}`, 'bot');
        } else {
            appendMsgWithSteps(data.response, data.steps);
        }

        loadUserChats();
    } catch (e) {
        thinkDiv.remove();
        appendMsg("âŒ ×©×’×™××ª ×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª.", 'bot');
    } finally {
        btn.disabled = false;
    }
}

// â”€â”€ DOM helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function appendMsg(content, role) {
    const win = document.getElementById('chat-window');
    const div = document.createElement('div');
    div.className = `message ${role}`;
    div.innerHTML = DOMPurify.sanitize(marked.parse(content));
    win.appendChild(div);
    win.scrollTop = win.scrollHeight;
}

function appendMsgWithSteps(content, steps) {
    const win = document.getElementById('chat-window');
    const wrapper = document.createElement('div');
    wrapper.className = 'message bot';

    // Response text
    const responseDiv = document.createElement('div');
    responseDiv.innerHTML = DOMPurify.sanitize(marked.parse(content));
    wrapper.appendChild(responseDiv);

    // Steps toggle
    if (steps && steps.length > 0) {
        const toggle = document.createElement('div');
        toggle.className = 'steps-toggle';
        toggle.innerHTML = `â–¶ ×¤×™×¨×•×˜ ×©×œ×‘×™ ×”×¡×•×›×Ÿ (${steps.length} ×©×œ×‘×™×)`;

        const panel = document.createElement('div');
        panel.className = 'steps-panel';
        panel.innerHTML = buildStepsHTML(steps);

        toggle.onclick = () => {
            const open = panel.classList.toggle('open');
            toggle.innerHTML = `${open ? 'â–¼' : 'â–¶'} ×¤×™×¨×•×˜ ×©×œ×‘×™ ×”×¡×•×›×Ÿ (${steps.length} ×©×œ×‘×™×)`;
        };

        wrapper.appendChild(toggle);
        wrapper.appendChild(panel);
    }

    win.appendChild(wrapper);
    win.scrollTop = win.scrollHeight;
}

function buildStepsHTML(steps) {
    const moduleColors = {
        'AgentLLM':         '#6d28d9',
        'WeatherTool':      '#d97706',
        'AgriKnowledgeBase':'#0891b2'
    };
    return steps.map((step, i) => {
        const color = moduleColors[step.module] || '#374151';
        const promptStr  = JSON.stringify(step.prompt,  null, 2);
        const responseStr = JSON.stringify(step.response, null, 2);
        return `
        <div class="step-card">
            <div class="step-header" style="background:${color}">
                <span>×©×œ×‘ ${i + 1}</span>
                <span class="step-module-badge">${step.module}</span>
            </div>
            <div class="step-section">
                <strong>Prompt</strong>
                <pre>${escapeHtml(promptStr)}</pre>
            </div>
            <div class="step-section">
                <strong>Response</strong>
                <pre>${escapeHtml(responseStr)}</pre>
            </div>
        </div>`;
    }).join('');
}

function escapeHtml(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€ Keyboard shortcut â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('query').addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); runAgent(); }
});
</script>
</body>
</html>
